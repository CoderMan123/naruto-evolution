name: Release

on:
  push:
    tags:
      - v*

  workflow_dispatch:

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - name: Install BYOND
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install libc6:i386 libncurses5:i386 libstdc++6:i386
          sudo apt-get install unzip
          curl -OL http://www.byond.com/download/build/513/513.1542_byond_linux.zip
          unzip *_byond_linux.zip
          cd byond
          sudo make install

      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          lfs: true
      
      - name: Checkout LFS objects
        run: git lfs checkout

      - name: Initialize submodules
        run: |
          git submodule init
          git submodule update --recursive

      - name: Build project
        run: DreamMaker "$GITHUB_WORKSPACE/naruto-evolution.dme"
      
      - name: Cache build
        uses: actions/cache@v2
        id: cache
        with:
          path: |
            $GITHUB_WORKSPACE/naruto-evolution.dmb
            $GITHUB_WORKSPACE/naruto-evolution.rsc
            $GITHUB_WORKSPACE/CHANGELOG.md
            $GITHUB_WORKSPACE/VERSION
          key: ${{ github.sha }}

  Release:
    runs-on: ubuntu-latest
    needs: [Build]
    steps:
      - name: Restore build
        uses: actions/cache@v2
        id: cache
        with:
          path: ./*
          key: ${{ github.sha }}
      
      - name: Release
        run: |
          gh auth login --with-token <<< ${{ secrets.GITHUB_TOKEN }}
          gh release create v$(cat $GITHUB_WORKSPACE/VERSION) --title $(cat VERSION) --notes-file CHANGELOG.md --target ${{ github.sha }} --draft
        